{% set  horizon_modules = [] %}

{%for node in stellar.nodes if node.horizon%}

{%set module_name_suffix = '{}_{}'.format(stellar.network_name, node.zone)%}
{%set stellar_core_module = 'stellar_core_{}'.format(module_name_suffix)%}
{%set horizon_module = 'horizon_{}'.format(module_name_suffix)%}
{%do horizon_modules.append({"name": horizon_module, "region": node.region})%}

module "{{horizon_module}}" {
  source = "modules/horizon"
  providers = {
    "aws" = "aws.{{node.region}}"
  }

  name = "${local.{{horizon_module}}_name}"

  instance_key_pair_name = "${aws_key_pair.{{node.region}}.key_name}"
  ssh_private_key = "{{stellar.ssh.private_key}}"

  stellar_network_name = "{{stellar.network_name}}"
  tld                  = "{{stellar.tld}}"
  zone                 = "{{node.zone}}"
  instance_type        = "{{stellar.instance_type}}"

  rds_password         = "{{env_vars['RDS_PASSWORD']}}"
}

output "ec2_horizon_{{horizon_module}}" {
  description = "EC2 public DNS name"
  value       = "${module.{{horizon_module}}.ec2}"
}

output "rds_horizon_{{horizon_module}}" {
  description = "RDS address"
  value       = "${module.{{horizon_module}}.rds}"
}

locals {
  {{horizon_module}}_name = "horizon-{{stellar.network_name}}-${random_id.{{'stellar_core_{}'.format(module_name_suffix)}}_name_suffix.hex}"
}

{%endfor%}

{%for module in horizon_modules%}
resource "aws_route53_record" "{{module.name}}" {
  provider = "aws.{{stellar.nodes|map(attribute="region")|first}}"

  zone_id = "${data.aws_route53_zone.kin.zone_id}"

  name    = "horizon-{{stellar.network_name}}.{{stellar.tld}}"
  type    = "CNAME"
  ttl     = "300"

  records = [
    "${module.{{module.name}}.elb}"
  ]

  health_check_id = "${aws_route53_health_check.{{module.name}}.id}"

  set_identifier = "{{module.name}}"
  latency_routing_policy = {
    region = "{{module.region}}"
  }
}

resource "aws_route53_health_check" "{{module.name}}" {
  provider = "aws.{{stellar.nodes|map(attribute="region")|first}}"

  fqdn              = "${module.{{module.name}}.elb}"
  type              = "HTTP"
  port              = 80
  resource_path     = "/"
  # port              = 8000
  # resource_path     = "/status"
  failure_threshold = "1"
  request_interval  = "30"

  tags = {
    Name = "${local.{{module.name}}_name}"
    type = "horizon"
    stellar-network = "{{stellar.network_name}}"
  }
}

data "aws_route53_zone" "kin" {
  provider = "aws.{{stellar.nodes|map(attribute="region")|first}}"

  name = "kininfrastructure.com."
}
{%endfor%}


{#
# vi: ft=terraform.jinja2
#}
